name: Type Check CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  type-check:
    name: Type Check All Packages
    runs-on: ubuntu-latest

    strategy:
      matrix:
        package:
          - name: floyd-agent-core
            path: packages/floyd-agent-core
            command: npm run build
          - name: floyd-cli
            path: INK/floyd-cli
            command: npm run build
          - name: FloydDesktopWeb
            path: FloydDesktopWeb
            command: npm run build
          - name: floydchrome
            path: FloydChromeBuild/floydchrome
            command: npm run typecheck

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            packages/floyd-agent-core/package-lock.json
            INK/floyd-cli/package-lock.json
            FloydDesktopWeb/package-lock.json
            FloydChromeBuild/floydchrome/package-lock.json

      - name: Install workspace dependencies
        run: npm ci

      - name: Install ${{ matrix.package.name }} dependencies
        run: cd ${{ matrix.package.path }} && npm ci

      - name: Run type check
        run: cd ${{ matrix.package.path }} && ${{ matrix.package.command }}

  # Summary job that runs after all type checks
  type-check-summary:
    name: Type Check Summary
    needs: type-check
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: All type checks passed
        if: needs.type-check.result == 'success'
        run: |
          echo "✅ All packages passed type check"
          exit 0

      - name: Type check failed
        if: needs.type-check.result == 'failure'
        run: |
          echo "❌ Type check failed for one or more packages"
          echo ""
          echo "Please fix the TypeScript errors before merging."
          echo ""
          echo "To reproduce locally:"
          echo "  cd packages/floyd-agent-core && npm run build"
          echo "  cd INK/floyd-cli && npm run build"
          echo "  cd FloydDesktopWeb && npm run build"
          echo "  cd FloydChromeBuild/floydchrome && npm run typecheck"
          exit 1
